<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>【golang】 slice - Shuvigoss-blog</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Shuvigoss-blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Shuvigoss-blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="使用golang已经快2年了，一直没有好好整理过基础知识，这次也好好整理一下，从最基本的slice开始，也把之前的一些疑惑进行自我解答 :)"><meta property="og:type" content="blog"><meta property="og:title" content="【golang】 slice"><meta property="og:url" content="http://example.com/2021/04/08/%E3%80%90golang%E3%80%91-%20slice/"><meta property="og:site_name" content="Shuvigoss-blog"><meta property="og:description" content="使用golang已经快2年了，一直没有好好整理过基础知识，这次也好好整理一下，从最基本的slice开始，也把之前的一些疑惑进行自我解答 :)"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:published_time" content="2021-04-08T08:25:24.000Z"><meta property="article:modified_time" content="2021-04-09T02:57:49.722Z"><meta property="article:author" content="Shuvigoss"><meta property="article:tag" content="Golang"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com/2021/04/08/%E3%80%90golang%E3%80%91-%20slice/"},"headline":"Shuvigoss-blog","image":["http://example.com/img/og_image.png"],"datePublished":"2021-04-08T08:25:24.000Z","dateModified":"2021-04-09T02:57:49.722Z","author":{"@type":"Person","name":"Shuvigoss"},"description":"使用golang已经快2年了，一直没有好好整理过基础知识，这次也好好整理一下，从最基本的slice开始，也把之前的一些疑惑进行自我解答 :)"}</script><link rel="canonical" href="http://example.com/2021/04/08/%E3%80%90golang%E3%80%91-%20slice/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Shuvigoss-blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">首页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-08T08:25:24.000Z" title="2021/4/8 下午4:25:24">2021-04-08</time>发表</span><span class="level-item"><time dateTime="2021-04-09T02:57:49.722Z" title="2021/4/9 上午10:57:49">2021-04-09</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Golang/">Golang</a></span><span class="level-item">13 分钟读完 (大约1914个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">【golang】 slice</h1><div class="content"><p>使用golang已经快2年了，一直没有好好整理过基础知识，这次也好好整理一下，从最基本的slice开始，也把之前的一些疑惑进行自我解答 :)</p>
<span id="more"></span>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestArray</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := [<span class="number">2</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;type is %T, value is %v\n&quot;</span>, s, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> is [<span class="number">2</span>]<span class="keyword">int</span>, value is [<span class="number">1</span> <span class="number">2</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>数组是不可变的,在go中基本上用的很少</p>
<h2 id="切片-Slice"><a href="#切片-Slice" class="headerlink" title="切片 Slice"></a>切片 Slice</h2><h3 id="切片创建"><a href="#切片创建" class="headerlink" title="切片创建"></a>切片创建</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSliceNew</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">//No.1</span></span><br><span class="line">	s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d , is nil %t\n&quot;</span>, <span class="built_in">len</span>(s1), <span class="built_in">cap</span>(s1), s1 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//No.2</span></span><br><span class="line">	s2 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d , is nil %t\n&quot;</span>, <span class="built_in">len</span>(s2), <span class="built_in">cap</span>(s2), s2 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//No.3</span></span><br><span class="line">	<span class="keyword">var</span> s3 []<span class="keyword">int</span></span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d , is nil %t\n&quot;</span>, <span class="built_in">len</span>(s3), <span class="built_in">cap</span>(s3), s3 == <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//No.4</span></span><br><span class="line">	<span class="comment">// new 函数返回是指针类型，所以需要使用 * 号来解引用</span></span><br><span class="line">	s4 := *<span class="built_in">new</span>([]<span class="keyword">int</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d , is nil %t\n&quot;</span>, <span class="built_in">len</span>(s3), <span class="built_in">cap</span>(s3), s4 == <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">=== RUN   TestSliceNew</span><br><span class="line"><span class="built_in">len</span> is <span class="number">3</span>, <span class="built_in">cap</span> is <span class="number">3</span> , is <span class="literal">nil</span> <span class="literal">false</span></span><br><span class="line"><span class="built_in">len</span> is <span class="number">0</span>, <span class="built_in">cap</span> is <span class="number">10</span> , is <span class="literal">nil</span> <span class="literal">false</span></span><br><span class="line"><span class="built_in">len</span> is <span class="number">0</span>, <span class="built_in">cap</span> is <span class="number">0</span> , is <span class="literal">nil</span> <span class="literal">true</span></span><br><span class="line"><span class="built_in">len</span> is <span class="number">0</span>, <span class="built_in">cap</span> is <span class="number">0</span> , is <span class="literal">nil</span> <span class="literal">true</span></span><br><span class="line">--- PASS: TestSliceNew (<span class="number">0.00</span>s)</span><br><span class="line">PASS</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>总共常用的是3中方式，其中第三种，第四种就不要用了，这里有2中类型，1个叫”nil切片”,1个叫”empty切片”，官方推荐使用nil切片，也就是<code>var s []int</code>这种方式</p>
<pre><code>The former declares a nil slice value, while the latter is non-nil but zero-length. They are functionally equivalent—their len and cap are both zero—but the nil slice is the preferred style.
</code></pre>
<p>那么这两种有什么区别呢？其实很简单，empty切片在创建时，都会使用同一内存地址来标识，<code>runtime/malloc.go</code>下边就这么写的</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgc</span><span class="params">(size <span class="keyword">uintptr</span>, typ *_type, needzero <span class="keyword">bool</span>)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> gcphase == _GCmarktermination &#123;</span><br><span class="line">		throw(<span class="string">&quot;mallocgc called with gcphase == _GCmarktermination&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> size == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> unsafe.Pointer(&amp;zerobase)</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">//xxxx</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// base address for all 0-byte allocations</span></span><br><span class="line"><span class="keyword">var</span> zerobase <span class="keyword">uintptr</span></span><br></pre></td></tr></table></figure>

<h3 id="下标操作"><a href="#下标操作" class="headerlink" title="下标操作"></a>下标操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">s[start:end]</span><br><span class="line">start 不能超过s的<span class="built_in">len</span>，起始位<span class="number">0</span></span><br><span class="line">end 不能超过<span class="built_in">cap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestIndex</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</span><br><span class="line">	s = <span class="built_in">append</span>(s, []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;...)</span><br><span class="line">	<span class="comment">//获取所有元素</span></span><br><span class="line">	fmt.Println(s[:])</span><br><span class="line">	<span class="comment">//从第一个元素开始（包含第一个），等同于[:]</span></span><br><span class="line">	fmt.Println(s[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">	fmt.Println(s[:<span class="built_in">cap</span>(s)])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br><span class="line">[<span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="insert-delete-copy-…"><a href="#insert-delete-copy-…" class="headerlink" title="insert delete copy …"></a>insert delete copy …</h3><p><a target="_blank" rel="noopener" href="https://ueokande.github.io/go-slice-tricks/">https://ueokande.github.io/go-slice-tricks/</a><br>详见这里了，很全</p>
<h3 id="append"><a href="#append" class="headerlink" title="append"></a>append</h3><p>append是最常用的方式，先来看这段代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSlice1</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d &quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	hdr := (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ptr is %x \n&quot;</span>, hdr.Data)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">1</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d &quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	hdr = (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ptr is %x \n&quot;</span>, hdr.Data)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">2</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d &quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	hdr = (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ptr is %x \n&quot;</span>, hdr.Data)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">3</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d &quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	hdr = (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ptr is %x \n&quot;</span>, hdr.Data)</span><br><span class="line"></span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">4</span>)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d &quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	hdr = (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;ptr is %x \n&quot;</span>, hdr.Data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">=== RUN   TestSlice1</span><br><span class="line"><span class="built_in">len</span> is <span class="number">0</span>, <span class="built_in">cap</span> is <span class="number">0</span> ptr is c00006ae58 </span><br><span class="line"><span class="built_in">len</span> is <span class="number">1</span>, <span class="built_in">cap</span> is <span class="number">1</span> ptr is c0000162c0 </span><br><span class="line"><span class="built_in">len</span> is <span class="number">2</span>, <span class="built_in">cap</span> is <span class="number">2</span> ptr is c0000162d0 </span><br><span class="line"><span class="built_in">len</span> is <span class="number">3</span>, <span class="built_in">cap</span> is <span class="number">4</span> ptr is c00001e100 </span><br><span class="line"><span class="built_in">len</span> is <span class="number">4</span>, <span class="built_in">cap</span> is <span class="number">4</span> ptr is c00001e100 </span><br><span class="line">--- PASS: TestSlice1 (<span class="number">0.00</span>s)</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure>

<p>从输出结果看，在append后，前3次的slice指针都变了，说明产生了新的slice，在slice的源码中可以看到如下代码<code>runtime/slice.go growslice</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">newcap := old.<span class="built_in">cap</span></span><br><span class="line">doublecap := newcap + newcap</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cap</span> &gt; doublecap &#123;</span><br><span class="line">    newcap = <span class="built_in">cap</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> old.<span class="built_in">cap</span> &lt; <span class="number">1024</span> &#123;</span><br><span class="line">        newcap = doublecap</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Check 0 &lt; newcap to detect overflow</span></span><br><span class="line">        <span class="comment">// and prevent an infinite loop.</span></span><br><span class="line">        <span class="keyword">for</span> <span class="number">0</span> &lt; newcap &amp;&amp; newcap &lt; <span class="built_in">cap</span> &#123;</span><br><span class="line">            newcap += newcap / <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Set newcap to the requested cap when</span></span><br><span class="line">        <span class="comment">// the newcap calculation overflowed.</span></span><br><span class="line">        <span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;</span><br><span class="line">            newcap = <span class="built_in">cap</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以这么解读，如果cap在1024下，每次slice的膨胀会乘以2，当超过1024后，会变为1.25（实际上不准确，后边有内存补齐的处理，基本维持在1.3左右）</p>
<p>那么不难看出，创建一个空slice后，append操作的cap为<code>0 -&gt; 1 -&gt; 2 -&gt; 4 -&gt; 8</code>，也就意味着第1、2、3次append都会产生新的slice，4、5次就会使用同一slice</p>
<h3 id="slice函数传递"><a href="#slice函数传递" class="headerlink" title="slice函数传递"></a>slice函数传递</h3><p>之前这个是我最不清楚的，也是一知半解，直接看一下代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSlice2</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line">	s = <span class="built_in">append</span>(s, []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;...)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;len is %d, cap is %d \n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s))</span><br><span class="line">	modify(s)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;修改后的值 %v\n&quot;</span>, s)</span><br><span class="line">	appendSlice(s)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;append后的值 %v\n&quot;</span>, s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modify</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	s[<span class="number">0</span>] = <span class="number">9</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== RUN   TestSlice2</span><br><span class="line"><span class="built_in">len</span> is <span class="number">5</span>, <span class="built_in">cap</span> is <span class="number">8</span> </span><br><span class="line">修改后的值 [<span class="number">9</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br><span class="line"><span class="built_in">append</span>后的值 [<span class="number">9</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span>]</span><br><span class="line">--- PASS: TestSlice2 (<span class="number">0.00</span>s)</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure>

<p>在modify函数内，改变了s[0]为9，输出后确实是，变化了，说明在传递时是”引用传递”(这里先用这个词来描述),但appendSlice操作后，并没有发生变化，难道不是”引用传递”吗？为什么会没有append成功？</p>
<p>首先这里先直接说结论，<code>go中没有引用传递，只有值传递</code> <a target="_blank" rel="noopener" href="https://golang.org/ref/spec#Calls">https://golang.org/ref/spec#Calls</a></p>
<pre><code>In a function call, the function value and arguments are evaluated in the usual order. After they are evaluated, the parameters of the call are passed by value to the function and the called function begins execution. The return parameters of the function are passed by value back to the caller when the function returns.
</code></pre>
<p>那么在go中有3个数据结构是特殊的，那就是<code>map、slice、chan</code>他们的类型叫做<code>reference types</code>,他们是”引用类型”，但在函数传递过程中，并不是”引用类型”，这块之前比较迷茫，现在就清晰了</p>
<pre><code>Map types are reference types, like pointers or slices, and so the value of m above is nil; it doesn&#39;t point to an initialized map. A nil map behaves like an empty map when reading, but attempts to write to a nil map will cause a runtime panic; don&#39;t do that. To initialize a map, use the built in make function:
</code></pre>
<p><a target="_blank" rel="noopener" href="https://blog.golang.org/maps">https://blog.golang.org/maps</a></p>
<p>先看下slice的结构定义，这里有2个，具体什么区别暂时还不清楚，但原理基本一样</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// runtime/slice.go</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">	array unsafe.Pointer</span><br><span class="line">	<span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line">	<span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reflect/value.go</span></span><br><span class="line"><span class="keyword">type</span> SliceHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">	Data <span class="keyword">uintptr</span></span><br><span class="line">	Len  <span class="keyword">int</span></span><br><span class="line">	Cap  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure>

<p>基本上都是1个指针，指着数组第一位内存地址</p>
<p>基于上述，修改一下之前的测试代码，就可以清楚的看出来参数传递的端倪</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSlice2</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">8</span>)</span><br><span class="line">	s = <span class="built_in">append</span>(s, []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;...)</span><br><span class="line"></span><br><span class="line">	hdr := (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;slice A len is %d, cap is %d , point is %p, 头指针为 %d\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), &amp;s, hdr.Data)</span><br><span class="line"></span><br><span class="line">	appendSlice(s)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取s的SliceHeader指针</span></span><br><span class="line">	hdr = (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	<span class="comment">//将Data转为int类型的数组，长度为8</span></span><br><span class="line">	newData := *(*[<span class="number">8</span>]<span class="keyword">int</span>)(unsafe.Pointer(hdr.Data))</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;输出s的第六位值为 %d\n&quot;</span>, newData[<span class="number">5</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">appendSlice</span><span class="params">(s []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	hdr := (*reflect.SliceHeader)(unsafe.Pointer(&amp;s))</span><br><span class="line">	fmt.Printf(<span class="string">&quot;slice B len is %d, cap is %d , point is %p, 头指针为 %d\n&quot;</span>, <span class="built_in">len</span>(s), <span class="built_in">cap</span>(s), &amp;s, hdr.Data)</span><br><span class="line">	s = <span class="built_in">append</span>(s, <span class="number">6</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">=== RUN   TestSlice2</span><br><span class="line">slice A <span class="built_in">len</span> is <span class="number">5</span>, <span class="built_in">cap</span> is <span class="number">8</span> , point is <span class="number">0xc0000ba030</span>, 头指针为 <span class="number">824634409344</span></span><br><span class="line">slice B <span class="built_in">len</span> is <span class="number">5</span>, <span class="built_in">cap</span> is <span class="number">8</span> , point is <span class="number">0xc0000ba048</span>, 头指针为 <span class="number">824634409344</span></span><br><span class="line">输出s的第六位值为 <span class="number">6</span></span><br><span class="line">--- PASS: TestSlice2 (<span class="number">0.00</span>s)</span><br><span class="line">PASS</span><br></pre></td></tr></table></figure>
<p>可以看出来，入参后，slice的指针为<code>0xc00000c060</code>，与<code>0xc00000c048</code>是不同的，说明传递的是值，也就是s的一份拷贝,然后slice下的Data指针却是一致的<code>824633852544</code>，说明指向的都是同一份内存地址</p>
<p>在appendSlice函数内进行了append,只是对<code>slice B</code>进行了append，并没有影响<code>slice A</code>,但是通过反射，将Data指针强转为长度为8的数组后，输出第5位值后发现，其实append是成功的，只是<code>slice A</code>并没有更新他的len,其实还可以再用如下方法进行修改</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	hdr.Len = <span class="number">6</span></span><br><span class="line">	fmt.Println(s[<span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="number">6</span></span><br></pre></td></tr></table></figure>
<p>原理是一致的</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li> slice分为”nil切片”、”empty切片”，建议使用”nil切片”</li>
<li> slice扩容在1024前是2倍，1024后是1.25倍，为了减少copy尽量指定slice长度</li>
<li> slice作为参数传递时，传递的是原slice的一份copy，只是data数据指针为同一数组指针</li>
</ol>
</div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Golang/">Golang</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2017/03/15/%E3%80%90Zookeeper%E3%80%91Curator-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%BB%E5%86%99%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/"><span class="level-item">【Zookeeper】Curator-分布式读写锁的实现</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="https://avatars.githubusercontent.com/u/3062921?s=400&amp;u=3543ec890bfdd459d1f5cab3ce24eeed892a9a8d&amp;v=4" alt="Shuvigoss"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Shuvigoss</p><p class="is-size-6 is-block">Shuvigoss-blog</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>BeiJing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">20</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">4</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/shuvigoss" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/shuvigoss"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://github.com/shuvigoss" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Github</span></span><span class="level-right"><span class="level-item tag">github.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/categories/Golang/"><span class="level-start"><span class="level-item">Golang</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Hexo/"><span class="level-start"><span class="level-item">Hexo</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/Zookeeper/"><span class="level-start"><span class="level-item">Zookeeper</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-08T08:25:24.000Z">2021-04-08</time></p><p class="title"><a href="/2021/04/08/%E3%80%90golang%E3%80%91-%20slice/">【golang】 slice</a></p><p class="categories"><a href="/categories/Golang/">Golang</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2017-03-15T08:13:58.000Z">2017-03-15</time></p><p class="title"><a href="/2017/03/15/%E3%80%90Zookeeper%E3%80%91Curator-%E5%88%86%E5%B8%83%E5%BC%8F%E8%AF%BB%E5%86%99%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">【Zookeeper】Curator-分布式读写锁的实现</a></p><p class="categories"><a href="/categories/Zookeeper/">Zookeeper</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2017-03-10T08:10:55.000Z">2017-03-10</time></p><p class="title"><a href="/2017/03/10/%E3%80%90Zookeeper%E3%80%91Curator-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E5%AE%9E%E7%8E%B0/">【Zookeeper】Curator-分布式锁的实现</a></p><p class="categories"><a href="/categories/Zookeeper/">Zookeeper</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2017-02-09T08:22:27.000Z">2017-02-09</time></p><p class="title"><a href="/2017/02/09/%E3%80%90ReentrantLock%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E3%80%91%E5%85%AC%E5%B9%B3%E9%94%81-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81/">【ReentrantLock源码分析】公平锁&amp;非公平锁</a></p><p class="categories"><a href="/categories/Java/">Java</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2016-09-23T09:00:33.000Z">2016-09-23</time></p><p class="title"><a href="/2016/09/23/%E3%80%90HttpComponents%E3%80%91%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%902-HttpCore&amp;nio/">【HttpComponents】源码分析2-HttpCore&amp;nio</a></p><p class="categories"><a href="/categories/Java/">Java</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/03/"><span class="level-start"><span class="level-item">三月 2017</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2017/02/"><span class="level-start"><span class="level-item">二月 2017</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2016/09/"><span class="level-start"><span class="level-item">九月 2016</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Distributed-Lock/"><span class="tag">Distributed Lock</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Golang/"><span class="tag">Golang</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/HttpComponents/"><span class="tag">HttpComponents</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ReentrantLock/"><span class="tag">ReentrantLock</span><span class="tag">1</span></a></div></div></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Shuvigoss-blog" height="28"></a><p class="is-size-7"><span>&copy; 2021 Shuvigoss</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>